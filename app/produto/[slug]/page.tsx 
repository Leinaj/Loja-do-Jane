import Image from 'next/image';
import { notFound } from 'next/navigation';
import { products } from '@/lib/products';

function slugify(s: string) {
  return s
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

export function generateStaticParams() {
  return (products ?? []).map((p: any) => ({ slug: p.slug ?? slugify(p.name) }));
}

function AddToCartButton({ item }: { item: any }) {
  'use client';
  const onClick = () => {
    try {
      const cartRaw = window.localStorage.getItem('cart');
      const cart = cartRaw ? JSON.parse(cartRaw) : [];
      cart.push({ ...item, qty: 1, slug: item.slug ?? slugify(item.name) });
      window.localStorage.setItem('cart', JSON.stringify(cart));
      alert('Adicionado ao carrinho âœ…');
    } catch {}
  };
  return (
    <button onClick={onClick} className="btn btn-primary">
      Adicionar ao carrinho
    </button>
  );
}

export default function ProductPage({ params }: { params: { slug: string } }) {
  const list = (products ?? []).map((p: any) => ({
    ...p,
    slug: p.slug ?? slugify(p.name),
  }));
  const item = list.find((p: any) => p.slug === params.slug);
  if (!item) return notFound();

  return (
    <div className="container mx-auto max-w-4xl p-4">
      <div className="relative w-full aspect-[4/3] overflow-hidden rounded-2xl bg-zinc-900">
        <Image
          src={item.image}
          alt={item.name}
          fill
          className="object-cover"
          sizes="100vw"
        />
      </div>

      <h1 className="mt-6 text-3xl font-extrabold">{item.name}</h1>
      <p className="mt-1 text-zinc-400">R$ {item.price.toFixed(2)}</p>
      {item.description ? (
        <p className="mt-2 text-zinc-300">{item.description}</p>
      ) : null}

      <div className="mt-4 flex gap-2">
        <AddToCartButton item={item} />
        <a href="/#produtos" className="btn btn-ghost">Voltar</a>
      </div>

      <hr className="my-6 border-zinc-800" />
      <section>
        <h2 className="text-2xl font-bold">Pagamento & Contato</h2>
        <p className="mt-2 text-zinc-300">
          WhatsApp:&nbsp;
          <a className="underline" href="https://wa.me/5544988606483">
            +55 (44) 98860-6483
          </a>
        </p>
        <p className="mt-1 text-zinc-300">PIX: 44988606483</p>
      </section>
    </div>
  );
}